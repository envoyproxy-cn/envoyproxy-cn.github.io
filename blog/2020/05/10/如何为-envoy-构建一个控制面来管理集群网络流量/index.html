<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.74.2"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>如何为 Envoy 构建一个控制面来管理集群网络流量 |</title><meta property="og:title" content="如何为 Envoy 构建一个控制面来管理集群网络流量"><meta property="og:description" content="这篇文章我看了之后非常想翻译，为什么呢？一方面我也在学习 Envoy，并且在公司的实际项目中使用 Envoy，另一方面，我确实也在设计一个控制管理端来统一管控多个集群的所有流量，没错我说的是所有的流量管控。"><meta property="og:type" content="article"><meta property="og:url" content="/blog/2020/05/10/%E5%A6%82%E4%BD%95%E4%B8%BA-envoy-%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%8E%A7%E5%88%B6%E9%9D%A2%E6%9D%A5%E7%AE%A1%E7%90%86%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C%E6%B5%81%E9%87%8F/"><meta property="article:published_time" content="2020-05-10T08:45:20+08:00"><meta property="article:modified_time" content="2020-09-07T01:19:38+08:00"><meta itemprop=name content="如何为 Envoy 构建一个控制面来管理集群网络流量"><meta itemprop=description content="这篇文章我看了之后非常想翻译，为什么呢？一方面我也在学习 Envoy，并且在公司的实际项目中使用 Envoy，另一方面，我确实也在设计一个控制管理端来统一管控多个集群的所有流量，没错我说的是所有的流量管控。"><meta itemprop=datePublished content="2020-05-10T08:45:20+08:00"><meta itemprop=dateModified content="2020-09-07T01:19:38+08:00"><meta itemprop=wordCount content="251"><meta itemprop=keywords content="envoy,mesh,"><meta name=twitter:card content="summary"><meta name=twitter:title content="如何为 Envoy 构建一个控制面来管理集群网络流量"><meta name=twitter:description content="这篇文章我看了之后非常想翻译，为什么呢？一方面我也在学习 Envoy，并且在公司的实际项目中使用 Envoy，另一方面，我确实也在设计一个控制管理端来统一管控多个集群的所有流量，没错我说的是所有的流量管控。"><link rel=preload href=/scss/main.min.e226c86e583aaf61ca1bcce636aaa0d0bbeebe95c29d67c149aa547ec23c4094.css as=style><link href=/scss/main.min.e226c86e583aaf61ca1bcce636aaa0d0bbeebe95c29d67c149aa547ec23c4094.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="200" height="269" viewBox="0 0 522 169" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Envoy_Logo_Final_PANTONE-REVERSE</title><desc>Created with Sketch.</desc><defs><polygon id="path-1" points="0 0.449 0 87.94 91.22 87.94 91.22 0.449"/><polygon id="path-3" points="0.695126691 0.484 191.856996 0.484 191.856996 163.037966 0.695126691 163.037966"/></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Envoy_Logo_Final_PANTONE-REVERSE"><path d="M294.535 85.529C294.463 83.366 294.12 81.383 293.507 79.579 292.895 77.777 291.975 76.21 290.75 74.875 289.522 73.541 287.991 72.494 286.152 71.738 284.313 70.981 282.167 70.601 279.716 70.601 277.337 70.601 275.155 71.052 273.172 71.953 271.187 72.857 269.511 74.028 268.141 75.469 266.771 76.912 265.708 78.517 264.95 80.283 264.193 82.051 263.815 83.799 263.815 85.529H294.535zM263.815 93.317C263.815 95.554 264.302 97.591 265.275 99.43 266.249 101.269 267.529 102.837 269.115 104.135 270.7 105.433 272.539 106.443 274.632 107.163 276.723 107.886 278.886 108.245 281.122 108.245 284.151 108.245 286.782 107.543 289.02 106.136 291.253 104.73 293.309 102.874 295.185 100.565L302.54 106.191C297.131 113.186 289.559 116.683 279.824 116.683 275.785 116.683 272.125 115.996 268.845 114.628 265.563 113.259 262.787 111.365 260.515 108.948 258.245 106.533 256.494 103.685 255.269 100.404 254.042 97.122 253.43 93.571 253.43 89.747 253.43 85.926 254.097 82.375 255.432 79.093 256.765 75.813 258.604 72.964 260.948 70.548 263.291 68.132 266.086 66.239 269.332 64.868 272.576 63.499 276.109 62.813 279.933 62.813 284.476 62.813 288.316 63.607 291.453 65.194 294.59 66.78 297.167 68.853 299.187 71.413 301.205 73.974 302.666 76.859 303.568 80.066 304.469 83.276 304.92 86.54 304.92 89.856V93.317H263.815z" id="Fill-1" fill="#fffffe"/><path d="M313.358 64.111H323.093V72.007H323.309C324.534 69.267 326.663 67.05 329.691 65.355 332.72 63.661 336.217 62.813 340.183 62.813 342.635 62.813 344.998 63.192 347.268 63.949 349.54 64.707 351.523 65.879 353.218 67.464 354.912 69.052 356.264 71.088 357.275 73.577 358.284 76.064 358.79 79.004 358.79 82.392V115.385H349.053V85.097C349.053 82.716 348.729 80.68 348.081 78.985 347.431 77.292 346.566 75.921 345.483 74.875 344.403 73.829 343.159 73.073 341.752 72.603 340.346 72.134 338.885 71.899 337.372 71.899 335.351 71.899 333.477 72.224 331.746 72.873S328.502 74.55 327.202 75.956C325.904 77.362 324.894 79.147 324.174 81.31 323.453 83.475 323.093 86.035 323.093 88.991V115.385H313.358V64.111" id="Fill-2" fill="#fffffe"/><polyline id="Fill-3" fill="#fffffe" points="361.925 64.111 373.176 64.111 388.537 103.378 403.248 64.111 413.632 64.111 393.513 115.385 382.804 115.385 361.925 64.111"/><path d="M424.668 89.747C424.668 92.345 425.063 94.742 425.857 96.941 426.65 99.143 427.768 101.016 429.211 102.567 430.652 104.117 432.418 105.344 434.511 106.244 436.602 107.147 438.946 107.596 441.542 107.596 444.138 107.596 446.481 107.147 448.573 106.244 450.664 105.344 452.43 104.117 453.873 102.567 455.315 101.016 456.432 99.143 457.227 96.941 458.02 94.742 458.417 92.345 458.417 89.747 458.417 87.151 458.02 84.755 457.227 82.555 456.432 80.356 455.315 78.481 453.873 76.929 452.43 75.38 450.664 74.155 448.573 73.251 446.481 72.351 444.138 71.899 441.542 71.899 438.946 71.899 436.602 72.351 434.511 73.251 432.418 74.155 430.652 75.38 429.211 76.929 427.768 78.481 426.65 80.356 425.857 82.555 425.063 84.755 424.668 87.151 424.668 89.747zM414.283 89.747C414.283 85.999 414.987 82.501 416.392 79.255 417.798 76.01 419.727 73.163 422.179 70.709 424.63 68.259 427.515 66.329 430.833 64.922 434.149 63.516 437.718 62.813 441.542 62.813 445.363 62.813 448.933 63.516 452.251 64.922 455.567 66.329 458.453 68.259 460.906 70.709 463.356 73.163 465.286 76.01 466.693 79.255 468.098 82.501 468.802 85.999 468.802 89.747 468.802 93.498 468.098 97.014 466.693 100.295 465.286 103.578 463.356 106.425 460.906 108.841 458.453 111.257 455.567 113.167 452.251 114.574 448.933 115.98 445.363 116.683 441.542 116.683 437.718 116.683 434.149 115.98 430.833 114.574 427.515 113.167 424.63 111.257 422.179 108.841 419.727 106.425 417.798 103.578 416.392 100.295 414.987 97.014 414.283 93.498 414.283 89.747z" id="Fill-4" fill="#fffffe"/><path d="M469.557 64.111h11.25L495.99 104.135H496.208L510.771 64.111H521.155L496.817 126.418C495.954 128.653 495.056 130.692 494.123 132.531 493.19 134.368 492.076 135.938 490.785 137.236 489.491 138.534 487.93 139.543 486.097 140.264 484.266 140.984 482.022 141.346 479.365 141.346 477.928 141.346 476.473 141.255 475.002 141.075 473.529 140.895 472.111 140.517 470.747 139.94L471.931 131.07C473.864 131.863 475.799 132.259 477.734 132.259 479.238 132.259 480.51 132.06 481.55 131.665 482.587 131.267 483.483 130.692 484.237 129.933 484.988 129.177 485.615 128.293 486.118 127.283 486.618 126.273 487.12 125.12 487.623 123.822L490.774 115.709 469.557 64.111" id="Fill-5" fill="#fffffe"/><polyline id="Fill-6" fill="#953984" points="56.279 81.853 56.601 95.448 70.917 104.324 70.596 90.72 56.279 81.853"/><g id="Group-10" transform="translate(0.000000, 81.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><g id="Clip-8"/><path d="M91.22 57.357 90.907 44.042 78.361 36.268C78.175 36.152 78.01 36.016 77.829 35.894L78.146 49.254 91.22 57.357" id="Fill-7" fill="#953984" mask="url(#mask-2)"/><path d="M46.52 75.284 13.788 55.002 12.992 20.964 29.039 14.044 28.717.449 3.107 11.49C1.137 12.347-.047 14.154.001 16.262L.962 57.097C1.01 59.204 2.29 61.267 4.313 62.53L43.567 86.856C45.396 87.987 47.602 88.297 49.462 87.709 49.659 87.647 49.838 87.576 50.017 87.506L74.105 77.122 61.04 69.022 46.52 75.284" id="Fill-9" fill="#953984" mask="url(#mask-2)"/></g><path d="M152.283 81.075C152.223 78.627 150.736 76.202 148.374 74.744L100.716 45.207 99.245 45.842 99.582 60.134 137.32 83.514 138.222 121.754 152.655 130.698 153.442 130.358 152.283 81.075" id="Fill-11" fill="#ac6199"/><g id="Group-15" transform="translate(34.000000, 0.000000)"><mask id="mask-4" fill="#fff"><use xlink:href="#path-3"/></mask><g id="Clip-13"/><path d="M61.206 148.199 16.93 120.759 15.842 74.699 36.014 66.01 35.64 50.146 4.319 63.648C2.022 64.649.637 66.769.697 69.216L1.972 123.211C2.02 125.663 3.514 128.071 5.876 129.53L57.772 161.701C59.91 163.024 62.482 163.383 64.65 162.698 64.872 162.628 65.088 162.546 65.297 162.452L95.953 149.237 80.709 139.791 61.206 148.199" id="Fill-12" fill="#ac6199" mask="url(#mask-4)"/><path d="M118.133 137.748 60.302 101.911 58.88 41.761 115.291 17.448 173.116 53.272 174.538 113.422 118.133 137.748zM185.76 43.255 119.219 2.011C116.764.49 113.838.089 111.335.88 111.089.958 110.848 1.047 110.611 1.148L45.707 29.137C43.078 30.271 41.497 32.686 41.563 35.49L43.195 104.712C43.26 107.516 44.968 110.27 47.664 111.941L114.2 153.172C116.646 154.687 119.573 155.099 122.061 154.313 122.307 154.235 122.56 154.142 122.807 154.036L187.717 126.059C190.346 124.925 191.921 122.498 191.855 119.693L190.23 50.484C190.164 47.68 188.456 44.925 185.76 43.255z" id="Fill-14" fill="#c04589" mask="url(#mask-4)"/></g></g></g></svg></span><span class="text-uppercase font-weight-bold"></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/community/><span>社区</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">博客</a></li><ul><li class="collapse show" id=blog><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/code/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">源码分析</a></li><ul><li class=collapse id=blogcode><a class="td-sidebar-link td-sidebar-link__page" id=m-blog20200823envoye6ba90e7a081e58886e69e90e4b98bdispatchere69cbae588b6 href=/blog/2020/08/23/envoy%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bdispatcher%E6%9C%BA%E5%88%B6/>Envoy源码分析之Dispatcher机制</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20200823envoye6ba90e7a081e58886e69e90e4b98bthreadlocale69cbae588b6 href=/blog/2020/08/23/envoy%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bthreadlocal%E6%9C%BA%E5%88%B6/>Envoy源码分析之ThreadLocal机制</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page active" id=m-blog20200510e5a682e4bd95e4b8ba-envoy-e69e84e5bbbae4b880e4b8aae68ea7e588b6e99da2e69da5e7aea1e79086e99b86e7bea4e7bd91e7bb9ce6b581e9878f href=/blog/2020/05/10/%E5%A6%82%E4%BD%95%E4%B8%BA-envoy-%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%8E%A7%E5%88%B6%E9%9D%A2%E6%9D%A5%E7%AE%A1%E7%90%86%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C%E6%B5%81%E9%87%8F/>如何为 Envoy 构建一个控制面来管理集群网络流量</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/envoyproxy-cn/envoyproxy-cn.io/edit/master/content/zh/blog/building-a-control-plane-to-manage-envoy/index.md target=_blank><i class="fa fa-edit fa-fw"></i>编辑此页</a>
<a href="https://github.com/envoyproxy-cn/envoyproxy-cn.io/issues/new?title=%e5%a6%82%e4%bd%95%e4%b8%ba%20Envoy%20%e6%9e%84%e5%bb%ba%e4%b8%80%e4%b8%aa%e6%8e%a7%e5%88%b6%e9%9d%a2%e6%9d%a5%e7%ae%a1%e7%90%86%e9%9b%86%e7%be%a4%e7%bd%91%e7%bb%9c%e6%b5%81%e9%87%8f" target=_blank><i class="fab fa-github fa-fw"></i>提交文档问题</a>
<a href=https://github.com/envoyproxy-cn/envoyproxy-cn.io/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>提交项目问题</a></div><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#指导在服务边缘构建控制面来管理-envoy-proxy让它作为服务网关或者在服务网格中使用>指导在服务边缘构建控制面来管理 Envoy Proxy，让它作为服务网关或者在服务网格中使用</a></li><li><a href=#使用-envoy-的-xds-api-动态配置-envoy>使用 Envoy 的 xDS API 动态配置 Envoy</a></li><li><a href=#总结>总结</a></li><li><a href=#下一步>下一步</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=/blog/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1>如何为 Envoy 构建一个控制面来管理集群网络流量</h1><div class="td-byline mb-4">By <b>helight</b> |
<time datetime=2020-05-10 class=text-muted>2020年5月10日</time></div><h2 id=前言>前言</h2><p>这篇文章我看了之后非常想翻译，为什么呢？一方面我也在学习 Envoy，并且在公司的实际项目中使用 Envoy，另一方面，我确实也在设计一个控制管理端来统一管控多个集群的所有流量，没错我说的是所有的流量管控。目前这个管理系统在内部已经在逐步使用起来了。所以翻译这篇文章，即学习 Envoy 技术，也是想做一个参考，印证我的想法是不是 OK 的，取长补短。</p><h2 id=指导在服务边缘构建控制面来管理-envoy-proxy让它作为服务网关或者在服务网格中使用>指导在服务边缘构建控制面来管理 Envoy Proxy，让它作为服务网关或者在服务网格中使用</h2><p>Envoy 已经成为了一个非常流行的网络组件了。Matt Klein <a href=https://blog.envoyproxy.io/the-universal-data-plane-api-d15cec7a>几年前写过一篇博文</a>，就在讨论 Envoy 的动态配置 API 和它如何成为 Envoy 被采用越来越多的原因之一。他在博文中说这是“统一数据面板 API”（UDPA）。随着很多其它项目都采用 Envoy 作为其核心组件，可以毫不夸张的说 Envoy 不仅仅建立了标准 API，而且对于应用 7 层的网络解决方案来说：“Envoy 已经变成了在云原生架构下的统一数据平面”。</p><p><img src=imgs/envoy.png alt></p><p>而且，由于 Envoy 的统一数据平面 API，我们可以看到业界开发了很多针对基于 Envoy 技术设施进行配置管理的管理系统。本文将会深入讨论为 Envoy 构建一个控制平面需要什么，大家可以通过这些信息来评估什么样的基础设施最适合你的组织和场景。因为这个是一个很大的话题，作者会出一个系列文章来对此进行详细说明（后面我也会挑一些我感兴趣的文章进行翻译学习）。</p><p>在 <a href=https://blog.envoyproxy.io/envoycon-recap-579d53576511>EnvoyCon/KubeCon 论坛有很多非常好的讨论</a>，这里好多组织都分享了他们采用 Envoy 的经验，也包括了如何构建他们自己的控制平面。下面是一些他们为什么选择自建控制平面的原因：</p><ol><li>现有的解决方案构建在不同的数据平面上，而且已经有了控制平面，需要在这里兼容 Envoy。</li><li>为不包含任何开源基础设施来构建，或者使用其它的 Envoy 控制平面（比如：VMs， AWS，ECS 等）。</li><li>不需要使用所有 Envoy 的特性，只是需要一部分。</li><li>为了更好适配自己的工作流和工作视图而需要为 Envoy 配置开发专属领域的 API 对象模型。</li><li>要线上使用，但是发现其它的控制平面并不够成熟。</li></ol><p><img src=imgs/control-plane-data-plane.png alt></p><p>然而，仅仅因为有些早期使用者构建了他们自己的控制平面，这并不意味着你也应该做这样的事情。首先在去年中很多为 Envoy 开发的控制平面已经相当成熟了，所以你应该在决定要重新开发另外一个控制平面之前先来研究一下这些已经存在的。其次，正如 Datawire 的人们发现，并且 Daniel Bryant 最近也发文章说，为 Envoy 构建一个控制平面并不是那么容易的。</p><p>我参与开发几个为 Enovy 构建控制平面的开源项目。比如，Gloo 是一个功能性网关，它可以作为强大的 Kubernetes 接入服务，API 网关，或者作为从单体服务到微服务过度的功能网关。Gloo 有一个针对 Envoy 的控制平面，它可以作为我这个系列文章的例子，来说明如何在控制平面上按照需求来抽象设计，以实现插件管理和扩展性管理。其它可以参考的已经实现的控制平面如 istio 和 <a href=https://github.com/heptio/contour>Heptio Contour</a>，这些也是贯穿我这个系列文章中的好例子。如果你确定要自己开发控制平面，那么除了这些，你还可以参考其它一些已经存在的控制平面。</p><p><img src=imgs/envoyprojects.png alt></p><p>在这个系列文章中，我们将会关注以下一些关键点：</p><ol><li>采用一种机制可以动态更新 Envoy 的路由，服务发现和其它配置。</li><li>识别使用哪些组件来构成你的控制平面，包括了后端存储，服务发现 API，安全组件等等。</li><li>根据场景和团队组织以最合适的方式建立任意制定区域的配置对象和 API。</li><li>思考如何在需要的地方以最好方式嵌入控制平面。</li><li>部署各种控制平面组件的方式。</li><li>思考如何测试控制平面。</li></ol><p>要开始这一系列的讨论，我们首先来看看如何在 Envoy 运行时，使用 Envoy 的动态配置 API 来更新 Envoy，以处理拓扑和部署中的变更。</p><h2 id=使用-envoy-的-xds-api-动态配置-envoy>使用 Envoy 的 xDS API 动态配置 Envoy</h2><p>在 Envoy 之上构建构控制平面的主要方便支持处在于它的数据平面 API。有了数据平面 API，我们可就可以动态的配置 Envoy 的大多数重要运行时设置。通过 xDS API 进行的 Envoy 配置是被设计为最终一致性的，没有一种方法可以对集群中的所有代理进行原子性的更新。当控制平面上有配置更新时，它就通过 xDS API 让数据平面代理都可以获取到，每个代理都是相互独立的来获取应用这些配置。</p><p>下面是我们可以通过 xDS 动态配置 Envoy 的部分运行时模型：</p><ol><li><a href=https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/listeners/lds#config-listeners-lds>监听发现服务（LDS）API</a> - LDS 用于下发服务监听的端口。</li><li><a href=https://www.envoyproxy.io/docs/envoy/v1.9.0/api-v2/api/v2/eds.proto#envoy-api-file-envoy-api-v2-eds-proto>终端发现服务（EDS）API</a>- EDS 用户服务发现。</li><li><a href=https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/http_conn_man/rds#config-http-conn-man-rds>路由发现服务（RDS）API</a>- RDS 用于流量路由决策。</li><li><a href=https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/cluster_manager/cds#config-cluster-manager-cds>集群发现服务（CDS）</a>- CDS 用于可以路由流量过去的后端服务。</li><li><a href=https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/secret>密钥发现服务（SDS）</a> - SDS 用户分发密钥（证书和密钥）。</li></ol><p><img src=imgs/xds-control-plane.png alt></p><p>这些 API 使用 proto3 的 Protocol Buffer 来定义的，并且已经有一些相关实现了，可以提供大家在构建自己的控制平面时参考：</p><ol><li><a href=https://github.com/envoyproxy/go-control-plane>go-control-plane</a></li><li><a href=https://github.com/envoyproxy/java-control-plane>java-control-plane</a></li></ol><p>虽然每个 xDS（LDS/EDS/RDS/CDS/SDS，这些统称xDS）都是可以动态可配置的，但是这并不意味着你必须动态配置所有内容。你可以组合适应，区分静态配置和动态配置。例如，要通过配置实现一种类型的服务发现：希望终端是动态的，但是集群在部署的时候就是已经知道路由信息了，所以你可以使用 Envoy 中的 <a href=https://www.envoyproxy.io/docs/envoy/v1.9.0/api-v2/api/v2/eds.proto#envoy-api-file-envoy-api-v2-eds-proto>Endpoint Discovery Service</a> 来静态的定义集群的配置。如果在部署的时候你不确定是那个上游集群，那你可以使用<a href=https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/cluster_manager/cds#config-cluster-manager-cds>Cluster Discovery Service</a>来动态的配置发现上游。关键是你可以构建一个工作流和处理流程来静态的配置你需要的部分，而且可以使用动态 xDS 服务在运行时发现你需要的部分。为什么有不同的控制平面实现，其中一个原因就是并不是所有人都有一个完全动态和可替代的环境（这个环境下所有的配置都应该是动态的），这点几乎不可能。根据现有条件的约束和可用工作流，要为你的系统采取合适级别的动态配置，而不是全动态配置。</p><p>在 Gloo 的实现中，我们基于 go-control-plane 的实现来构建控制平面，实现了 xDS API 到 Envoy 的动态配置。Istio 和 Heptio Contour 也是使用这种方式。这个控制平面的 API 使用 gRPC streaming 实现，并且留了实现接口，所以我们在实现的时候只需要实现这些接口就可以了。这种方式可以以非常高效的方式把 Envoy 数据平面 API 集成到控制平面中。</p><p>gRPC streaming 方式并不是唯一的更新 Envoy 配置的方法。在<a href=https://www.envoyproxy.io/docs/envoy/v1.5.0/api-v1/api>Envoy 早期版本中的 xDS API</a>，轮询是唯一检测是否有新配置可用的方式。虽然这也是接受的，并且也符合配置更新最终一致性的原则，但是在网络和计算使用上还是不够高效。也比较困难去调整优化轮询配置以减少资源浪费。</p><p>最后，一些 Envoy 管理系统的实现采取生成<a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/overview/v2_overview#static>静态 Envoy 配置文件</a>和给 Envoy 周期性的覆盖写入磁盘上的配置文件，再执行<a href=https://blog.envoyproxy.io/envoy-hot-restart-1d16b14555b5>Envoy 进程的热重启</a>。在高度动态环境中（像 Kubernetes，实际上任何短暂的计算平台都算），管理这种文件的生成，传递，热重启等等会显得非常笨重。Envoy 最初就是在这样操作的（Lyft公司创建这个项目是就是这样），但是它逐步发展到现在的 xDS API了。</p><h2 id=总结>总结</h2><p>Gloo 团队相信使用 gRPC streaming 和 xDS API 来实现对 Envoy 的动态配置和控制是一种比较好的方式。同样，并不是所有的 Envoy 配置都应该是动态的，尤其是你不需要动态配置的内容。但是如果你是在一个高度动态的环境（比如在 Kubernetes 中），动态配置 Envoy 就很关键了。其它的环境或许也有这样的需要。不管怎么样，动态配置使用 gRPC streaming API 是最理想的，主要有以下一些好处：</p><ol><li>事件驱动配置更新；在控制平面中配置会在可用的时候下发到 Envoy。</li><li>不需要轮询配置变化了。</li><li>不需要热重启 Envoy。</li><li>不会中断流量。</li></ol><h2 id=下一步>下一步</h2><p>这是系列文章的第一部分，我们只是建立了为 Envoy 构建控制平面的基本概念，简述了 xDS API 和对 Envoy 动态配置不同的考虑。在下一节，会在几天后发布，将会把控制面分解成为可部署的组件，确定你需要的组件，特定领域对象会是什么样子？以及对控制平面扩展插件的思考。</p><p>​英文原文: <a href=https://blog.christianposta.com/envoy/guidance-for-building-a-control-plane-to-manage-envoy-proxy-based-infrastructure/>https://blog.christianposta.com/envoy/guidance-for-building-a-control-plane-to-manage-envoy-proxy-based-infrastructure/</a></p><center>看完本文有收获？请分享给更多人<p>关注「黑光技术」，关注大数据+微服务</p><p><img src=/img/qrcode_helight_tech.jpg alt></p></center><br><div id=utter-container></div><script src=https://utteranc.es/client.js repo=envoyproxy-cn/comments issue-term=pathname theme=github-light crossorigin=anonymous async></script><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a class="btn btn-primary disabled"><span class=mr-1>←</span> 上一页</a></li><a class="btn btn-primary disabled">下一页 <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/envoyproxy-cn/envoyproxy-cn.io><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://envoyproxy.slack.com/archives/C018HMZH37F><i class="fab fa-slack"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020 Envoy中文社区 All Rights Reserved</small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.664f21bf5eb0c31ebc661e2616e6c63e0448cec6d5636d869957be423c3cb952.js integrity="sha256-Zk8hv16wwx68Zh4mFubGPgRIzsbVY22GmVe+Qjw8uVI=" crossorigin=anonymous></script></body></html>